# [在 C/C++项目中应用 DevOps 所面临的挑战](https://devops.com/devops-challenges-c-c-projects/)

C++是一个非常强大的语言,拥有很好的性能,被工业界所喜爱并持续使用. DevOps 已经在其它主要的软件开发领域(例如 Java)中广泛应用,并且 DevOps 方案确实能够带来帮助,但是实现现代 C/C++ DevOps 并不容易。

让我们来看一看 C/C++开发者所面临的挑战,以及其如何解决。

## tl;dr

C/C++由于众多原因被很多开发者所喜爱.但是由于 C/C++语言及其生态系统的特性,在 C/C++工程中实现现代 DevOps 和持续集成并不容易.这里,我们拥有知识和经验来鉴别 C/C++中实现 DevOps 所要满足的需求,我将在以下内容中展示这是可能的.

## 构建 C/C++工程

理想情况下,我们希望给开发者提供的 CI/CD 流程能够尽可能地顺畅和快速.但是,对比其它开发语言,C/C++开发者面临更大的挑战:

- 较长的构建时间

  这并不是因为 C/C++编译器比较慢.事实上他们非常快,而且集中了一些 IT 世界最先进的技术.但是 C/C++有头文件的问题,需要预处理器在每个转换单元不断地复制每个所包含的头文件,使得要编译的代码行迅速膨胀.已经有一些机制(譬如预编译头)来部分缓解这个问题.另外,与其它语言相比,C/C++较多地用在那些庞大的工程中,这些工程拥有数百万行代码,一个典型的 AAA 有着两千万行代码.

- 不同的平台和生态系统有着不同的构建系统

  C/C++应用广泛,譬如计算机、嵌入式设备、移动设备等等.但是每个平台都会用不同的编译器(Windows 上使用 MSVC 的 cl.exe,Linux 上使用 GCC,OSX 上使用 apple-clang),以及不同的构建系统.广泛应用的构建系统有 CMake、MSBuild、Makefiles 及 autotools,但是有些公司使用其它的构建系统,甚至会开发自己的解决方案.

- 二进制兼容

  C/C++会被编译成本机/二进制代码,但是不同的编译器,甚至于编译器的不同版本构造出来的二进制代码都不兼容.这个问题被成为 ABI 不兼容,而其它语言不需要处理这个问题.ABI 不兼容会导致链接失败,能够在构建时发现,但经常会产生运行时错误.

- 代码内联和潜入

  动态库直接将链接到的静态库二进制代码嵌入到自身.不仅如此,静态库也会将其他库的代码嵌入到自身.这意味着即使源代码没用改变,如果依赖变换了,也需要进行重新构建.

- 开源代码软件缺乏标准

  开源代码软件经常将其代码置于 GitHub、GitLab 或者 Bitbucket 中,但是并不将其置于可用状态.用户通常需要从源代码构建成二进制、从系统库管理器获取预先构建的二进制、或者使用其它安装或者预编译模块.然后通常还需要根据构建系统做出调整,在不同的平台下也会不一样.

## 现代 DevOps 针对 C/C++的需求

那么为了应用现代 DevOps 实践和工具,针对 C/C++工程有哪些要求呢?

- 管理和重用二进制

  每次从源代码构建非常昂贵、容易出错、而且针对大型项目不可伸缩.重用二进制应当针对不同的平台上保持一致,能够解决 ABI 兼容问题.

- 在一个仓库或者服务器上管理所有库

  对于开发者或者 DevOps 来说在不同的系统中创建或者维护包成本非常高.能够从同一位置存储、管理及获取二进制能够极大地简化流程,也能够节省大量时间.

- 适应从旧版到最新的任何构建系统、平台和工具.

  如果所有人使用同一个构建系统,那么创建好的 CI 和包管理将会非常简单.但是希望工程可以合并到一个构建系统这想法太天真了.合并一些库或者工程到新的构建系统是一项巨大的投资,可能需要数月时间.流程和工具应当能够适应任何构建系统和现存的工具.

- 与其它工具进行良好的集成

  不仅仅是构建系统,工具应当和其它类型的工具尽可能简单地集成.例如,持续集成平台 Travis、Appveyor 云服务、Jenkins.还需要和流行的 IDE 集成良好,以及测试、代码覆盖、静态分析、多种版本控制系统等等.

## 以 Conan C/C++包管理器为例

Conan 是免费的开源软件 C/C++包管理器.它去中心化、可移植、多平台,能够在很多操作系统上运行,目标是任何可能的 C/C++应用目标.

Conan 通过以下方式来满足上述需求:

- Conan 可以构建、上传、共享任意数量的不同配置.它管理二进制文件,根据需要为每个相应的平台检索正确的,必要的时候从源代码构建,来最小化 ABI 不兼容问题.

- Conan 包和预构建二进制文件可以上传到服务器上共享给团队或者公司范围,也可以使用 JFrog Bintray 进行世界范围的分发.所有支持的平台的所有不同二进制文件都可以在具有完全相同接口的同一服务器中上载和管理。

- Conan 可以与任何构建系统一起工作.内建了与 CMake、Visual Studio、Makefiles、SCons、QMake 等等的集成.甚至可以使用"generator"来扩展支持其它的构建系统.这意味着可以将 Conan 依赖模型转换到其它构建系统格式,来供构建系统使用.

- Conan 与不同的 CI 系统集成良好,使用特定的工具能够和 Travis、Appveyor 及 GitLab 集成.

Conan 使用 Python 编写,这意味着可以使用标准 Python 语法来扩展其行为,使得用户可以轻松地集成不同的工具:静态分析、测试、代码覆盖等等.

让我们以 DevOps 的视角审视一个典型流程,来说明 Conan 如何工作.首先开发人员针对特定库(LibB)源代码做一些修改,提交更改到源代码管理器(Git Repo).

![Conan DevOps](https://3ovyg21t17l11k49tk1oma21-wpengine.netdna-ssl.com/wp-content/uploads/2017/12/Cpic1.png)

这时 CI 系统监听 Git 仓库,理想情况下使用 Git hooks,然后触发 Jenkins.以下是 Jenkins 流水线的示例:
![Jenkins example](https://3ovyg21t17l11k49tk1oma21-wpengine.netdna-ssl.com/wp-content/uploads/2017/12/pipeline.png)

示例的第一阶段比较直接,第二阶段调用了包创建,在内部会被分成两个子任务:

1. LibB 的依赖以二进制格式获取
2. 根据依赖图得到的所有依赖项进行构建

## 结论

C/C++相对于其它语言,在开发过程中有些额外的挑战.虽然这使得其在实现 DevOps 时面临更多挑战,但并不意味着不可能实现.我们应当更新工具来满足开发人员的需求.你在你的 C/C++工程中是如何实现 DevOps 准则和实践的呢?
